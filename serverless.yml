service: ms-app-nics
frameworkVersion: "3"
useDotenv: true

provider:
  stage: ${opt:stage, 'development'}
  name: aws
  region: us-west-2
  deploymentMethod: direct
  deploymentBucket: 
    name: clemence-sandbox-deployment-bucket
  deploymentPrefix: ${self:service}-${self:provider.stage}
  runtime: nodejs16.x
  versionFunctions: true
  timeout: 900
  endpointType: private
  tags:
    app: ${self:service}
    env: ${self:provider.stage}
  stackTags:
    app: ${self:service}
    env: ${self:provider.stage}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:*
          Resource: "arn:aws:dynamodb:*:*:table/${self:custom.config.AppDynamoDbTableName}"
plugins:
  - serverless-offline
  - serverless-localstack

custom:
  config:
    AppDynamoDbTableName: ${self:service}-${self:provider.stage}-AppDynamoDbTable
  localstack:
    stages:
      - development
      - dev
      - local
    host: http://localstack  # optional - LocalStack host to connect to
    edgePort: 4566  # optional - LocalStack edge port to connect to
    autostart: false  # optional - Start LocalStack in Docker on Serverless deploy
    lambda:
      mountCode: false

resources:
  Resources:
    AppDynamoDB:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.config.AppDynamoDbTableName}
        KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
        AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        BillingMode: PAY_PER_REQUEST
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        TableClass: STANDARD
        TimeToLiveSpecification:
          AttributeName: EXPIRATION_TIMESTAMP
          Enabled: True
        GlobalSecondaryIndexes:
        - IndexName: GSI0
          Projection:
            ProjectionType: ALL
          KeySchema:
          - AttributeName: SK
            KeyType: HASH
          - AttributeName: PK
            KeyType: RANGE

    APIRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
          - Effect: Allow
            Principal:
              Service:
              - apigateway.amazonaws.com
            Action:
              - sts:AssumeRole
        Policies:
        - PolicyName: APIPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: ["dynamodb:*"]
                Resource: !GetAtt AppDynamoDB.Arn
              - Effect: Allow
                Action: ["apigateway:POST"]
                Resource: 
                  Fn::Join:
                  - ''
                  - - 'arn:'
                    - !Ref AWS::Partition
                    - ":apigateway:"
                    - !Ref AWS::Region
                    - ":"
                    - !Ref AWS::AccountId
                    - ":"
                    - !Ref RestApiGateway
                    - "/"
                    - ${self:provider.stage}
                    - "/*"

    LambdaExecutionRole:
      Type: "AWS::IAM::Role"
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - lambda.amazonaws.com
              Action:
                - "sts:AssumeRole"
        Path: /
        Policies:
          - PolicyName: root
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - "logs:CreateLogGroup"
                    - "logs:CreateLogStream"
                    - "logs:PutLogEvents"
                  Resource: "arn:aws:logs:*:*:*"
                - Effect: Allow
                  Action: ["apigateway:POST"]
                  Resource: 
                    Fn::Join:
                    - ''
                    - - 'arn:'
                      - !Ref AWS::Partition
                      - ":apigateway:"
                      - !Ref AWS::Region
                      - "::/restapis/"
                      - !Ref RestApiGateway
                      - "/deployments"

    # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-function.html
    EnableLatestDeploymentFunction:
      Type: AWS::Lambda::Function
      Properties:
        Code:
          ZipFile: |
            const url = require('url');
            const https = require("https");
            const AWS = require('aws-sdk')
            const apiGateway = new AWS.APIGateway()

            const response = require('cfn-response');
            exports.handler = (event, context) => {
              console.log("Event", event, "Context", context);

              if (event.RequestType === "Delete") {
                const responseData = {operation: "Deletion, always success"}
                response.send(event, context, response.SUCCESS, responseData);
                return
              }

              const input = event.ResourceProperties;

              const deploymentCreationParams = {
                restApiId: input.ApiGatewayId, 
                stageName: input.ApiGatewayStageId, 
                description: "Created by the Custom Resource"
              }
              
              // const apiGatewayDeploymentCreationResult = await apiGateway.createDeployment(deploymentCreationParams).promise().catch(err => err)
              const apiGatewayDeploymentCreationResult = "created"
              console.log("Binding deployment", apiGatewayDeploymentCreationResult)
              const responseData = {Operation: "working", apiGatewayDeploymentCreationResult, ...deploymentCreationParams};
              response.send(event, context, response.SUCCESS, responseData);
              console.log("All done")
              return
            };

        Role: !GetAtt
          - LambdaExecutionRole
          - Arn
        Runtime: nodejs16.x
        Handler: index.handler
        Timeout: 20
        MemorySize: 128

    # EnableLatestDeploymentCustomResource:
    #   Type: AWS::CloudFormation::CustomResource
    #   Properties:
    #     ServiceToken: !GetAtt EnableLatestDeploymentFunction.Arn
    #     ApiGatewayId: !Ref RestApiGateway
    #     ApiGatewayStageId: !Ref RestApiGatewayStage

    ApiGatewayDeployment:
      Type: AWS::ApiGateway::Deployment
      DependsOn:
      - RestApiGatewayRootPostMethod
      - RestApiGatewayProductGetMethod
      Properties:
        RestApiId: !Ref RestApiGateway
        Description: "Created from Serverless"

    RestApiGatewayStage:
      Type: AWS::ApiGateway::Stage
      Properties:
        RestApiId: 
          Ref: RestApiGateway
        StageName: autodeploy
        DeploymentId:
          Ref: ApiGatewayDeployment

    RestApiGateway:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Description: ${self:provider.stage}-${self:service} API Gateway
        EndpointConfiguration:
          Types:
            - REGIONAL
        Name: ${self:provider.stage}-${self:service}

    BadRequestParametersResponse:
      Type: 'AWS::ApiGateway::GatewayResponse'
      Properties:
        RestApiId: 
          Ref: 'RestApiGateway'
        ResponseType: BAD_REQUEST_PARAMETERS
        ResponseTemplates:
          application/json: "{\"success\":false,\"message\":\"Invalid Parameters: $context.error.validationErrorString\"}"
        StatusCode: '400'

    BadRequestBodyResponse:
      Type: 'AWS::ApiGateway::GatewayResponse'
      Properties:
        RestApiId: 
          Ref: 'RestApiGateway'
        ResponseType: BAD_REQUEST_BODY
        ResponseTemplates:
          application/json: "{\"success\":false,\"message\":\"Invalid Body: $context.error.validationErrorString\"}"
        StatusCode: '400'

    RestApiGatewayRootResource:
      Type: AWS::ApiGateway::Resource
      Properties:
        PathPart: prices
        ParentId:
          Fn::GetAtt:
            - RestApiGateway
            - RootResourceId
        RestApiId:
          Ref: RestApiGateway

    EmptyModelSchema:
      Type: "AWS::ApiGateway::Model"
      Properties:
        RestApiId: !Ref RestApiGateway
        Description: "Empty Model"
        Schema: |
            {
              "$schema": "http://json-schema.org/draft-04/schema#",
              "title" : "Empty Schema",
              "type" : "object"
            }
        ContentType: "application/json"
    PricesPostModel:
      Type: "AWS::ApiGateway::Model"
      Properties:
        RestApiId: !Ref RestApiGateway
        Description: "Prices"
        Schema: |
            {
              "$schema": "http://json-schema.org/draft-04/schema#",
              "title" : "Prices Schema",
              "type" : "object",
              "definitions": {
                "metadata": {
                  "type": "object",
                  "properties": {
                    "topic_name": {"type": "string"},
                    "publisher": {"type": "string"},
                    "publishing_timestamp": {"type": "integer"},
                    "publication_timestamp": {"type": "integer"},
                    "request_id": {"type": "string"}
                  },
                  "required": ["topic_name", "publisher", "publishing_timestamp", "publication_timestamp"]
                },
                "aggregate": {
                  "type": "object",
                  "properties": {
                    "id":  {"type": "string"},
                    "prices": {"type": "array", "items": {"$ref": "#/definitions/singlePrice"}}
                  },
                  "required": ["id", "prices"]
                },
                "singlePrice": {
                  "type": "object",
                  "properties": {
                    "amount":  {"type": "number"},
                    "currency_code":  {"type": "string"},
                    "price_type":  {"type": "string", "enum": ["REGULAR_PRICE", "SALE_PRICE"]},
                    "country_code": {"type": "string", "pattern": "^[A-Z]{2,2}$"}
                  },
                  "required": ["amount", "currency_code", "price_type","country_code"]
                }
              },
              "properties": {
                "metadata": { "$ref": "#/definitions/metadata"},
                "aggregate": { "$ref": "#/definitions/aggregate"}
              },
              "required": ["aggregate"]
            }
        ContentType: "application/json"

    RestApiGatewayRootPostMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        RestApiId: !Ref RestApiGateway
        ResourceId: !Ref RestApiGatewayRootResource
        HttpMethod: POST
        AuthorizationType: "NONE"
        Integration:
          Credentials:
            Fn::GetAtt: 
            - APIRole
            - Arn
          Uri: !Sub
            - arn:aws:apigateway:${AWS::Region}:dynamodb:action/PutItem
            - {}
          PassthroughBehavior: "when_no_match"
          IntegrationHttpMethod: POST
          Type: AWS
          RequestTemplates:
            application/json:
              Fn::Sub: 
                - |-
                  { 
                    "TableName": "${tableName}",
                    "Item": {
                            "PK": { "S": "PRICES#${productCode}" },
                            "SK": { "S": "PRICES#${payloadTimestamp}" },
                            "METADATA": { "S": "${metadata}"},
                            "AGGREGATE": { "S": "${aggregate}"},
                            "PAYLOAD": { "S": "${payload}" },
                            "PUBLICATION_TIMESTAMP": { "N": "${payloadTimestamp}" },
                            "RECEIVED_TIMESTAMP": { "N": "${currentTimestamp}" }
                          },
                    "ConditionExpression": "(attribute_not_exists(PUBLICATION_TIMESTAMP) or PUBLICATION_TIMESTAMP <= :payloadTimestamp) and (:currentTimestamp > :payloadTimestamp)",
                    "ExpressionAttributeValues": {
                      ":payloadTimestamp": {"N": "${payloadTimestamp}"},
                      ":currentTimestamp": {"N": "${currentTimestamp}"}
                    }
                  }
                - { 
                    tableName: { Ref: AppDynamoDB }, 
                    productCode: "$util.escapeJavaScript($input.path('$.aggregate.id'))", 
                    payload: "$util.escapeJavaScript($input.body)",
                    metadata: "$util.escapeJavaScript($input.json('$.metadata'))",
                    aggregate: "$util.escapeJavaScript($input.json('$.aggregate'))",
                    currentTimestamp: "$context.requestTimeEpoch",
                    payloadTimestamp: "$util.escapeJavaScript($input.path('$.metadata.publication_timestamp'))",
                  }
          IntegrationResponses:
          - StatusCode: 200
            SelectionPattern: 2\d{2}
            ResponseParameters: {}
            ResponseTemplates: 
              application/json: |
                {"status": "200"}
          - StatusCode: 400
            SelectionPattern: 4\d{2}
            ResponseParameters: {}
            ResponseTemplates: 
              application/json: |
                #set($message = $input.path('$.message'))
                #if($message == "The conditional request failed")
                  #set($message = "Timestamp Validation Failed. The original request contains a publication_timestamp / publishing_timestamp of the future.")
                #end
                {"status": "400", "error: "$util.escapeJavaScript($message)"}
        RequestValidatorId:
          Ref: RestApiGatewayRootPostRequestValidator
        RequestModels:
          "application/json": !Ref PricesPostModel
        MethodResponses:
        - ResponseParameters:
          ResponseModels: {}
          StatusCode: 200
        - ResponseParameters: {}
          ResponseModels: {}
          StatusCode: 400
        - ResponseParameters: {}
          ResponseModels: {}
          StatusCode: 500
    RestApiGatewayRootPostRequestValidator:
      Type: AWS::ApiGateway::RequestValidator
      Properties: 
        RestApiId: !Ref RestApiGateway
        ValidateRequestBody: True
        ValidateRequestParameters: False
    
    RestApiGatewayProductCodeResource:
      Type: AWS::ApiGateway::Resource
      Properties:
        RestApiId: !Ref RestApiGateway
        ParentId: !Ref RestApiGatewayRootResource
        PathPart: "{productCode+}"

    RestApiGatewayProductGetMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        RestApiId: !Ref RestApiGateway
        ResourceId: !Ref RestApiGatewayProductCodeResource
        HttpMethod: GET
        AuthorizationType: "NONE"
        Integration:
          Credentials:
            Fn::GetAtt: 
            - APIRole
            - Arn
          Uri: !Sub
            - arn:aws:apigateway:${AWS::Region}:dynamodb:action/Query
            - {}
          PassthroughBehavior: "when_no_match"
          IntegrationHttpMethod: POST
          Type: AWS
          RequestTemplates:
            application/json:
              Fn::Sub: 
                - |-
                  { 
                    "ConsistentRead": true,
                    "TableName": "${tableName}",
                    "ScanIndexForward": false,
                    "KeyConditionExpression": "PK = :keyParam",
                    "ExpressionAttributeValues": {
                      ":keyParam": { "S": "PRICES#${productCode}"}
                    }
                  }
                - { 
                    tableName: { Ref: AppDynamoDB }, 
                    productCode: "$util.escapeJavaScript($input.params('productCode'))"
                  }
          IntegrationResponses:
          - StatusCode: 200
            SelectionPattern: 2\d{2}
            ResponseParameters: {}
            ResponseTemplates: 
              application/json: |
                #set($inputRoot = $input.path('$'))
                #set($count = $input.path('$.Count'))
                {
                  "count": $count,
                  "items": [
                    #foreach($item in $inputRoot.Items)
                    {
                      "aggregate": $item.AGGREGATE.S, 
                      "metadata": $item.METADATA.S, 
                      "timeline": {"received_by_pricing_at": $item.RECEIVED_TIMESTAMP.N}
                    }
                    #if($foreach.hasNext),#end
                    #end
                  ]
                }

              
          - StatusCode: 400
            SelectionPattern: 4\d{2}
            ResponseParameters: {}
            ResponseTemplates: 
              application/json: |
                {"status": "400"}
        MethodResponses:
        - ResponseParameters:
          ResponseModels: {}
          StatusCode: 200
        - ResponseParameters: {}
          ResponseModels: {}
          StatusCode: 400
        - ResponseParameters: {}
          ResponseModels: {}
          StatusCode: 500